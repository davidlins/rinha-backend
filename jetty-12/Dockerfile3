FROM maven:3.9.3-eclipse-temurin-17-alpine as build

ENV JETTY_HOME /usr/local/jetty
ENV JETTY_BASE /var/lib/jetty

RUN set -xe ; \
    
    mkdir -p $JETTY_HOME ; \
    
    wget https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-home/12.0.0/jetty-home-12.0.0.tar.gz; \
    tar -xzvf jetty-home-12.0.0.tar.gz; \
    mv jetty-home-12.0.0/* $JETTY_HOME; \
        
    #java -Djetty.base=$JETTY_BASE -jar "$JETTY_HOME/start.jar" --create-startd --add-modules=server,http,ext,resources,ee10-deploy,ee10-webapp,ee10-annotations ; \
     
    addgroup -S jetty && adduser -h $JETTY_BASE -S jetty -G jetty; \
    chown -R jetty:jetty "$JETTY_HOME"; \
    chown -R jetty:jetty "$JETTY_BASE"; \

    rm -rf jetty-home-12.0.0.tar.gz; \
    rm -rf jetty-home-12.0.0; 

WORKDIR /app
COPY src /app/src
COPY pom.xml /app

RUN mvn clean package -DskipTests

FROM eclipse-temurin:20-jdk-alpine

ENV JETTY_HOME /usr/local/jetty
ENV JETTY_BASE /var/lib/jetty

RUN set -xe ; \
    
    mkdir -p $JETTY_HOME ; \
    mkdir -p JETTY_BASE ; \
    
    addgroup -S jetty && adduser -h $JETTY_BASE -S jetty -G jetty; \
    chown -R jetty:jetty "$JETTY_HOME"; \
    chown -R jetty:jetty "$JETTY_BASE"; 

COPY --from=build --chown=jetty:jetty $JETTY_HOME/* $JETTY_HOME/


RUN set -xe ; \
    
    mkdir -p $JETTY_HOME ; \
    mkdir -p JETTY_BASE ; \
    
    addgroup -S jetty && adduser -h $JETTY_BASE -S jetty -G jetty; \
    chown -R jetty:jetty "$JETTY_HOME"; \
    chown -R jetty:jetty "$JETTY_BASE"; 


RUN java -Djetty.base=$JETTY_BASE -jar $JETTY_HOME/start.jar --create-startd --add-modules=server,http,ext,resources,ee10-deploy,ee10-webapp,ee10-annotations



COPY --from=build --chown=jetty:jetty app/target/rinha-backend-jetty-servlet.war $JETTY_BASE/webapps/ROOT.war




EXPOSE 8080
#CMD ["java","-jar","/usr/local/jetty/start.jar"] 
CMD ["bash"]